<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 대시보드 - 에겐테토</title>
    <meta name="description" content="나의 테스트 기록과 통계를 확인하세요">
    
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <link rel="stylesheet" href="css/styles-new.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
</head>
<body>
    <!-- 헤더 -->
    <header class="site-header">
        <div class="header-container">
            <div class="logo-area">
                <a href="index.html" class="logo">
                    <img src="assets/icons/brain.svg" alt="" class="logo-icon">
                    <span class="logo-text">에겐테토</span>
                </a>
            </div>
            
            <nav class="main-nav">
                <button class="nav-item active" data-category="all">
                    <img src="assets/icons/sparkles.svg" alt="" class="nav-icon">
                    <span class="nav-text">전체</span>
                </button>
                <button class="nav-item" data-category="personality">
                    <img src="assets/icons/mask.svg" alt="" class="nav-icon">
                    <span class="nav-text">성격</span>
                </button>
                <button class="nav-item" data-category="love">
                    <img src="assets/icons/heart.svg" alt="" class="nav-icon">
                    <span class="nav-text">연애</span>
                </button>
                <button class="nav-item" data-category="fun">
                    <img src="assets/icons/party.svg" alt="" class="nav-icon">
                    <span class="nav-text">재미</span>
                </button>
                <button class="nav-item" data-category="psychology">
                    <img src="assets/icons/puzzle.svg" alt="" class="nav-icon">
                    <span class="nav-text">심리</span>
                </button>
            </nav>
            
            <div class="auth-section">
                <div id="userMenu" class="user-menu">
                    <div class="user-info" onclick="toggleUserDropdown()">
                        <img src="assets/icons/user.svg" alt="" class="user-avatar">
                        <span id="userEmail" class="user-email">Loading...</span>
                        <img src="assets/icons/arrow-down.svg" alt="" class="dropdown-arrow">
                    </div>
                    <div id="userDropdown" class="user-dropdown" style="display: none;">
                        <a href="dashboard.html" class="dropdown-item active">
                            <img src="assets/icons/dashboard.svg" alt="">
                            <span>내 대시보드</span>
                        </a>
                        <a href="history.html" class="dropdown-item">
                            <img src="assets/icons/history.svg" alt="">
                            <span>테스트 기록</span>
                        </a>
                        <hr class="dropdown-divider">
                        <button class="dropdown-item logout-item" onclick="handleLogout()">
                            <img src="assets/icons/logout.svg" alt="">
                            <span>로그아웃</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 콘텐츠 -->
    <main class="main-content">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">내 대시보드</h1>
                <p class="dashboard-subtitle">나의 테스트 기록과 통계를 확인하세요</p>
            </div>

            <!-- 로딩 상태 -->
            <div id="dashboardLoading" class="dashboard-loading">
                <div class="loading-spinner"></div>
                <p>데이터를 불러오는 중...</p>
            </div>

            <!-- 로그인 필요 메시지 -->
            <div id="loginRequired" class="login-required" style="display: none;">
                <div class="login-message">
                    <img src="assets/icons/user.svg" alt="" class="login-icon">
                    <h2>로그인이 필요합니다</h2>
                    <p>대시보드를 사용하려면 로그인해주세요</p>
                    <button class="login-btn" onclick="location.href='index.html'">로그인하러 가기</button>
                </div>
            </div>

            <!-- 대시보드 내용 -->
            <div id="dashboardContent" class="dashboard-content" style="display: none;">
                <!-- 통계 카드 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="assets/icons/test-brain.svg" alt="">
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-number" id="totalTests">0</h3>
                            <p class="stat-label">완료한 테스트</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="assets/icons/fire.svg" alt="">
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-number" id="thisWeekTests">0</h3>
                            <p class="stat-label">이번 주 테스트</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="assets/icons/heart.svg" alt="">
                        </div>
                        <div class="stat-info">
                            <h3 class="stat-number" id="favoriteCategory">-</h3>
                            <p class="stat-label">선호 카테고리</p>
                        </div>
                    </div>
                </div>

                <!-- 최근 테스트 결과 -->
                <div class="recent-tests-section">
                    <div class="section-header">
                        <h2 class="section-title">최근 테스트 결과</h2>
                        <a href="history.html" class="view-all-btn">전체보기</a>
                    </div>
                    <div id="recentTests" class="recent-tests-grid">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>

                <!-- 추천 테스트 -->
                <div class="recommended-section">
                    <div class="section-header">
                        <h2 class="section-title">추천 테스트</h2>
                        <p class="section-subtitle">아직 시도해보지 않은 테스트들</p>
                    </div>
                    <div id="recommendedTests" class="recommended-tests-grid">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>에겐테토</h3>
                    <p>재미있는 심리테스트로 나를 알아가는 시간</p>
                </div>
                <div class="footer-links">
                    <a href="about.html">소개</a>
                    <a href="privacy.html">개인정보처리방침</a>
                    <a href="contact.html">문의하기</a>
                </div>
            </div>
            <p class="footer-note">본 테스트는 재미를 위한 것이며 전문적인 진단이 아닙니다.</p>
        </div>
    </footer>

    <script>
        let currentUser = null;
        let userTests = [];
        let allTests = [];

        // 페이지 로드 시 실행
        window.addEventListener('load', async () => {
            // 사용자 인증 상태 확인
            if (supabaseAuth) {
                currentUser = supabaseAuth.getCurrentUser();
                if (!currentUser) {
                    // 로그인되지 않은 경우
                    document.getElementById('dashboardLoading').style.display = 'none';
                    document.getElementById('loginRequired').style.display = 'block';
                    return;
                }
                
                // 사용자 정보 표시
                document.getElementById('userEmail').textContent = currentUser.email;
                
                // 대시보드 데이터 로드
                await loadDashboardData();
            } else {
                // Supabase 로드 실패
                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
            }
        });

        // 대시보드 데이터 로드
        async function loadDashboardData() {
            try {
                // 사용자 테스트 기록 가져오기
                const historyResult = await supabaseData.getUserTestHistory();
                if (historyResult.success) {
                    userTests = historyResult.data;
                }

                // 모든 테스트 가져오기
                const testsResult = await supabaseData.getAllTests();
                if (testsResult.success) {
                    allTests = testsResult.data;
                }

                // 통계 계산 및 표시
                calculateStats();
                renderRecentTests();
                renderRecommendedTests();

                // 로딩 완료
                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

            } catch (error) {
                console.error('대시보드 데이터 로드 실패:', error);
                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
            }
        }

        // 통계 계산
        function calculateStats() {
            const totalTests = userTests.length;
            
            // 이번 주 테스트 수 계산
            const thisWeek = new Date();
            thisWeek.setDate(thisWeek.getDate() - 7);
            const thisWeekTests = userTests.filter(test => 
                new Date(test.completed_at) > thisWeek
            ).length;

            // 선호 카테고리 계산
            const categoryCount = {};
            userTests.forEach(test => {
                if (test.tests && test.tests.category) {
                    const category = test.tests.category;
                    categoryCount[category] = (categoryCount[category] || 0) + 1;
                }
            });

            const favoriteCategory = Object.keys(categoryCount).length > 0 
                ? Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b
                )
                : '-';

            const categoryNames = {
                'personality': '성격',
                'love': '연애',
                'psychology': '심리',
                'fun': '재미'
            };

            // 통계 표시
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('thisWeekTests').textContent = thisWeekTests;
            document.getElementById('favoriteCategory').textContent = 
                categoryNames[favoriteCategory] || favoriteCategory;
        }

        // 최근 테스트 렌더링
        function renderRecentTests() {
            const recentTestsContainer = document.getElementById('recentTests');
            const recentTests = userTests.slice(0, 3); // 최근 3개

            if (recentTests.length === 0) {
                recentTestsContainer.innerHTML = `
                    <div class="no-tests">
                        <img src="assets/icons/test-brain.svg" alt="" class="no-tests-icon">
                        <p>아직 완료한 테스트가 없습니다</p>
                        <a href="index.html" class="start-test-btn">첫 테스트 시작하기</a>
                    </div>
                `;
                return;
            }

            recentTestsContainer.innerHTML = recentTests.map(test => `
                <div class="recent-test-card">
                    <div class="test-thumbnail">
                        <img src="${test.tests?.thumbnail_icon || 'assets/icons/test-brain.svg'}" alt="">
                    </div>
                    <div class="test-info">
                        <h3 class="test-title">${test.tests?.title || '테스트'}</h3>
                        <p class="test-result">결과: ${test.result_type}</p>
                        <p class="test-date">${formatDate(test.completed_at)}</p>
                    </div>
                    <div class="test-actions">
                        <button class="view-result-btn" onclick="viewResult('${test.id}')">
                            결과보기
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 추천 테스트 렌더링
        function renderRecommendedTests() {
            const recommendedContainer = document.getElementById('recommendedTests');
            
            // 사용자가 완료하지 않은 테스트 찾기
            const completedTestIds = userTests.map(test => test.test_id);
            const recommendedTests = allTests.filter(test => 
                !completedTestIds.includes(test.id)
            ).slice(0, 3);

            if (recommendedTests.length === 0) {
                recommendedContainer.innerHTML = `
                    <div class="no-tests">
                        <img src="assets/icons/sparkles.svg" alt="" class="no-tests-icon">
                        <p>모든 테스트를 완료하셨습니다!</p>
                    </div>
                `;
                return;
            }

            recommendedContainer.innerHTML = recommendedTests.map(test => `
                <div class="recommended-test-card" onclick="location.href='${getTestUrl(test.test_id)}'">
                    <div class="test-thumbnail">
                        <img src="${test.thumbnail_icon}" alt="">
                        ${test.is_new ? '<span class="badge new">NEW</span>' : ''}
                        ${test.is_hot ? '<span class="badge hot">HOT</span>' : ''}
                    </div>
                    <div class="test-info">
                        <div class="test-category">
                            <img src="${test.category_icon}" alt="">
                            <span>${test.category_name}</span>
                        </div>
                        <h3 class="test-title">${test.title}</h3>
                        <p class="test-subtitle">${test.subtitle}</p>
                        <div class="test-meta">
                            <span class="duration">${test.duration}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 헬퍼 함수들
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) return '오늘';
            if (diffDays === 2) return '어제';
            if (diffDays <= 7) return `${diffDays}일 전`;
            
            return date.toLocaleDateString('ko-KR');
        }

        function getTestUrl(testId) {
            return testId === 'egen-teto' ? 'quiz.html' : `quiz.html?test=${testId}`;
        }

        function viewResult(resultId) {
            // 결과 상세 보기 (구현 예정)
            alert('결과 상세 보기는 준비 중입니다.');
        }

        // 사용자 메뉴 토글
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // 로그아웃
        async function handleLogout() {
            if (supabaseAuth) {
                const result = await supabaseAuth.signOut();
                if (result.success) {
                    location.href = 'index.html';
                }
            }
        }

        // 외부 클릭 시 드롭다운 닫기
        window.onclick = function(event) {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu.contains(event.target)) {
                document.getElementById('userDropdown').style.display = 'none';
            }
        }
    </script>
</body>
</html>