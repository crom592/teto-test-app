<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 연동 테스트</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }
        .test-result {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .auth-form {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>🚀 Supabase 연동 테스트</h1>
    
    <!-- 연결 상태 테스트 -->
    <div class="test-section">
        <div class="test-title">1. 연결 상태 확인</div>
        <button onclick="testConnection()">연결 테스트</button>
        <div id="connectionResult" class="test-result"></div>
    </div>

    <!-- 인증 테스트 -->
    <div class="test-section">
        <div class="test-title">2. 사용자 인증 테스트</div>
        <div class="auth-form">
            <input type="email" id="testEmail" placeholder="이메일" value="test@example.com">
            <input type="password" id="testPassword" placeholder="비밀번호" value="testpass123">
            <button onclick="testSignUp()">회원가입</button>
            <button onclick="testSignIn()">로그인</button>
            <button onclick="testSignOut()">로그아웃</button>
        </div>
        <div id="authResult" class="test-result"></div>
        <div id="currentUser" class="test-result info" style="display: none;"></div>
    </div>

    <!-- 데이터 조회 테스트 -->
    <div class="test-section">
        <div class="test-title">3. 데이터 조회 테스트</div>
        <button onclick="testGetTests()">테스트 목록 조회</button>
        <button onclick="testGetStats()">통계 조회</button>
        <div id="dataResult" class="test-result"></div>
    </div>

    <!-- 실시간 통계 -->
    <div class="test-section">
        <div class="test-title">4. 실시간 통계</div>
        <div class="stats-display" id="statsDisplay">
            <div class="stat-card">
                <div class="stat-number" id="totalParticipants">-</div>
                <div class="stat-label">총 참여자</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalTests">-</div>
                <div class="stat-label">총 테스트</div>
            </div>
        </div>
        <button onclick="startRealtimeStats()">실시간 구독 시작</button>
        <button onclick="stopRealtimeStats()">구독 중지</button>
        <div id="realtimeResult" class="test-result"></div>
    </div>

    <!-- 테스트 결과 저장 -->
    <div class="test-section">
        <div class="test-title">5. 테스트 결과 저장 (로그인 필요)</div>
        <button onclick="testSaveResult()">샘플 결과 저장</button>
        <button onclick="testGetHistory()">내 기록 조회</button>
        <div id="saveResult" class="test-result"></div>
    </div>

    <!-- Supabase 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let realtimeSubscription = null;

        // 연결 테스트
        async function testConnection() {
            const result = document.getElementById('connectionResult');
            try {
                result.innerHTML = '<div class="info">연결 테스트 중...</div>';
                
                // Supabase 클라이언트 상태 확인
                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase 클라이언트가 로드되지 않았습니다.');
                }
                
                // 간단한 쿼리로 연결 테스트
                const { data, error } = await supabase
                    .from('tests')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                result.innerHTML = '<div class="success">✅ Supabase 연결 성공!</div>';
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 연결 실패: ${error.message}</div>`;
            }
        }

        // 회원가입 테스트
        async function testSignUp() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('authResult');
            
            try {
                result.innerHTML = '<div class="info">회원가입 중...</div>';
                const response = await window.supabaseAuth.signUp(email, password);
                
                if (response.success) {
                    result.innerHTML = '<div class="success">✅ 회원가입 성공! 이메일 확인을 해주세요.</div>';
                } else {
                    result.innerHTML = `<div class="error">❌ 회원가입 실패: ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 로그인 테스트
        async function testSignIn() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('authResult');
            
            try {
                result.innerHTML = '<div class="info">로그인 중...</div>';
                const response = await window.supabaseAuth.signIn(email, password);
                
                if (response.success) {
                    result.innerHTML = '<div class="success">✅ 로그인 성공!</div>';
                    updateCurrentUser();
                } else {
                    result.innerHTML = `<div class="error">❌ 로그인 실패: ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 로그아웃 테스트
        async function testSignOut() {
            const result = document.getElementById('authResult');
            
            try {
                const response = await window.supabaseAuth.signOut();
                
                if (response.success) {
                    result.innerHTML = '<div class="success">✅ 로그아웃 성공!</div>';
                    document.getElementById('currentUser').style.display = 'none';
                } else {
                    result.innerHTML = `<div class="error">❌ 로그아웃 실패: ${response.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 현재 사용자 정보 업데이트
        function updateCurrentUser() {
            const user = window.supabaseAuth.getCurrentUser();
            const userDiv = document.getElementById('currentUser');
            
            if (user) {
                userDiv.innerHTML = `현재 사용자: ${user.email}`;
                userDiv.style.display = 'block';
            } else {
                userDiv.style.display = 'none';
            }
        }

        // 테스트 목록 조회
        async function testGetTests() {
            const result = document.getElementById('dataResult');
            
            try {
                result.innerHTML = '<div class="info">테스트 목록 조회 중...</div>';
                const tests = await window.supabaseData.getAllTests();
                
                if (tests.success) {
                    const testList = tests.data.map(test => 
                        `• ${test.title} (${test.category_name})`
                    ).join('<br>');
                    result.innerHTML = `<div class="success">✅ 테스트 목록 조회 성공!<br>${testList}</div>`;
                } else {
                    result.innerHTML = `<div class="error">❌ 조회 실패: ${tests.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 통계 조회
        async function testGetStats() {
            const result = document.getElementById('dataResult');
            
            try {
                result.innerHTML = '<div class="info">통계 조회 중...</div>';
                
                // 첫 번째 테스트의 통계 조회
                const { data: tests } = await supabase.from('tests').select('id').limit(1);
                if (tests && tests.length > 0) {
                    const stats = await window.supabaseData.getTestStatistics(tests[0].id);
                    
                    if (stats.success) {
                        result.innerHTML = `<div class="success">✅ 통계 조회 성공!<br>참여자: ${stats.data.total_participants}명</div>`;
                    } else {
                        result.innerHTML = `<div class="error">❌ 통계 조회 실패: ${stats.error}</div>`;
                    }
                } else {
                    result.innerHTML = '<div class="error">❌ 테스트 데이터가 없습니다.</div>';
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 실시간 통계 시작
        async function startRealtimeStats() {
            const result = document.getElementById('realtimeResult');
            
            try {
                result.innerHTML = '<div class="info">실시간 구독 시작 중...</div>';
                
                // 전체 통계 업데이트
                await updateStats();
                
                // 실시간 구독 시작
                realtimeSubscription = supabase
                    .channel('test_statistics')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'test_statistics' },
                        (payload) => {
                            console.log('실시간 업데이트:', payload);
                            updateStats();
                        }
                    )
                    .subscribe();
                
                result.innerHTML = '<div class="success">✅ 실시간 구독 시작됨!</div>';
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 실시간 구독 중지
        function stopRealtimeStats() {
            const result = document.getElementById('realtimeResult');
            
            if (realtimeSubscription) {
                realtimeSubscription.unsubscribe();
                realtimeSubscription = null;
                result.innerHTML = '<div class="success">✅ 실시간 구독 중지됨!</div>';
            } else {
                result.innerHTML = '<div class="info">구독 중인 채널이 없습니다.</div>';
            }
        }

        // 통계 업데이트
        async function updateStats() {
            try {
                // 총 참여자 수
                const { data: statsData } = await supabase
                    .from('test_statistics')
                    .select('total_participants');
                
                const totalParticipants = statsData?.reduce((sum, stat) => sum + stat.total_participants, 0) || 0;
                document.getElementById('totalParticipants').textContent = totalParticipants;
                
                // 총 테스트 수
                const { data: testsData } = await supabase
                    .from('tests')
                    .select('id');
                
                const totalTests = testsData?.length || 0;
                document.getElementById('totalTests').textContent = totalTests;
                
            } catch (error) {
                console.error('통계 업데이트 오류:', error);
            }
        }

        // 테스트 결과 저장
        async function testSaveResult() {
            const result = document.getElementById('saveResult');
            const user = window.supabaseAuth.getCurrentUser();
            
            if (!user) {
                result.innerHTML = '<div class="error">❌ 로그인이 필요합니다.</div>';
                return;
            }
            
            try {
                result.innerHTML = '<div class="info">결과 저장 중...</div>';
                
                // 첫 번째 테스트 ID 가져오기
                const { data: tests } = await supabase.from('tests').select('id').limit(1);
                if (!tests || tests.length === 0) {
                    throw new Error('테스트 데이터가 없습니다.');
                }
                
                const saveResponse = await window.supabaseData.saveTestResult(
                    tests[0].id,
                    'sample_result',
                    { score: 85, type: 'personality' }
                );
                
                if (saveResponse.success) {
                    result.innerHTML = '<div class="success">✅ 테스트 결과 저장 성공!</div>';
                } else {
                    result.innerHTML = `<div class="error">❌ 저장 실패: ${saveResponse.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 내 기록 조회
        async function testGetHistory() {
            const result = document.getElementById('saveResult');
            const user = window.supabaseAuth.getCurrentUser();
            
            if (!user) {
                result.innerHTML = '<div class="error">❌ 로그인이 필요합니다.</div>';
                return;
            }
            
            try {
                result.innerHTML = '<div class="info">기록 조회 중...</div>';
                
                const history = await window.supabaseData.getUserTestHistory();
                
                if (history.success) {
                    const historyList = history.data.map(record => 
                        `• ${record.result_type} (${new Date(record.completed_at).toLocaleDateString()})`
                    ).join('<br>');
                    
                    result.innerHTML = `<div class="success">✅ 기록 조회 성공!<br>${historyList || '기록이 없습니다.'}</div>`;
                } else {
                    result.innerHTML = `<div class="error">❌ 조회 실패: ${history.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">❌ 오류: ${error.message}</div>`;
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            updateCurrentUser();
            updateStats();
        });

        // 인증 상태 변경 감지
        window.supabaseAuth.onAuthStateChange((user) => {
            updateCurrentUser();
        });
    </script>
</body>
</html>
